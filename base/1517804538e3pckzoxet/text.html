<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Балансировка нагрузки между несколькими приложениями, бэкендами и серверами является частью процесса</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> </span><a href="https://ruhighload.com/post/%D0%90%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0+%D0%B2%D1%8B%D1%81%D0%BE%D0%BA%D0%B8%D1%85+%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D0%BA"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; text-decoration: underline; color:#e85f63;">оптимизации ресурсов</span></a><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;">, улучшения производительности и отказоустойчивости сервиса.</span><img src="image28185.png" /></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Nginx как load balancer</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Этот веб-сервер считается одним из самых популярных и производительных решений, ведь имеет широчайший функционал и</span><a href="https://ruhighload.com/index.php/2009/04/24/%d0%bd%d0%b0%d1%81%d1%82%d1%80%d0%be%d0%b9%d0%ba%d0%b0-nginx/"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; text-decoration: underline; color:#e85f63;">гибкость при настройке</span></a><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;">. Так что Nginx часто используется для балансировки нагрузки.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Подходов и реализаций несколько, но прежде проверьте наличие модуля</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> </span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; font-weight:600; color:#212529;">ngx_http_upstream_module</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;">:</span></p>
<p style=" margin-top:20px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">nginx -v</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Все установленные и исключенные модули будут содержаться в выводе</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Если же он отсутствует, то придется пересобрать Nginx, добавив этот модуль.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">После этого можно приступать к настройке веб-сервера. Для включения балансировки добавьте директиву</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#212529; background-color:#eeeeee;">upstream</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> (секция </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#212529; background-color:#eeeeee;">http</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;">) в файл конфигурации Nginx:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">upstream backend  {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">  server backend1.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">  server backend2.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">  server backend3.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Можно назначить несколько директив upstream</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Теперь нужно указать перенаправление необходимой группы:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">  location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    proxy_pass  </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">http://backend;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">  }</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Перенаправление также можно указать в директивах</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888;"> </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#888888; background-color:#eeeeee;">fastcgi_pass, memcached_pass, uwsgi_pass, scgi_pass</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Кроме этого Nginx поддерживает дополнительные параметры и методы распределения нагрузки.</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Выбор метода балансировки</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Nginx предлагает несколько методов балансировки нагрузки.</span><img src="image8183.png" /></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:51px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#333333; background-color:#ffffff;">Round-robin</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Веб-сервер по умолчанию распределяет запросы равномерно между бэкендами (но с учетом весов). Этот стандартный метод в Nginx, так что директива включения отсутствует.</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:51px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#333333; background-color:#ffffff;">least_conn</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Запросы сначала отправляются бэкенду с наименьшим количеством активных подключений (но с учетом весов):</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">upstream backend {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">least_conn;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    server backend1.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    server backend2.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Если количество активных соединений одинаково, то дополнительно используется метод round-robin</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:51px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#333333; background-color:#ffffff;">Hash и IP hash</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">При помощи этого метода можно создать своего рода постоянные соединения между клиентами и бэкендами.</span><img src="image2018.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Для каждого запроса Nginx вычисляет хэш, который состоит из текста, переменных веб-сервера или их комбинации, а затем сопоставляет его с бэкендами:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">upstream backend {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">   </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">hash $scheme$request_uri;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">   server backend1.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">   server backend2.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">   server backend3.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Для вычисления хэша используется схема (http или https) и полный URL</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">IP hash работает только с HTTP, это предопределенный вариант, в котором хэш вычисляется по IP-адресу клиента:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">upstream backend {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">   </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">ip_hash;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">   server backend1.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">   server backend2.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">   server backend3.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Если адрес клиента IPv4, то для хэша используется первые три октета, если IPv6, то весь адрес</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Веса бэкендов</span><img src="image9153.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Если в стеке определенные бэкенды мощнее, чем другие, то пригодятся веса:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">upstream backend {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    server backend1.somesite.com </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">weight=10;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    server backend2.somesite.com </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">weight=5;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    server backend3.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">server 192.0.0.1 backup;</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># По умолчанию веса равны 1</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">В этом примере из каждых 16 запросов первый бэкенд будет обрабатывать 10, второй 5, а третий 1. При этом бэкап-сервер будет получать запросы только если три основных бэкенда недоступны.</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Мониторинг</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Если Nginx считает, что бэкенд сервер недоступен, то временно перестает слать на него запросы. За это отвечает две директивы:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px; font-weight:600;">max_fails</span><span style=" font-size:20px;"> — задает количество неудачных попыток подключений, после которых бэкенд определенное время считается недоступным;</span></li>
<li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px; font-weight:600;">fail_timeout</span><span style=" font-size:20px;"> — время, в течение которого сервер считается недоступным.</span></li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Параметры выглядят так:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">upstream backend {                </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    server backend1.somesite.com;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    server backend2.somesite.com </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">max_fails=3 fail_timeout=30s;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">    server backend3.somesite.com </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">max_fails=2;</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Параметры по умолчанию: 1 попытка, 10 секунд таймаута</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Самое главное</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Выбор подходящего метода балансировки позволит сделать более равномерно распределить нагрузку. Не забывайте о весах бэкендов, мониторинге и отказоустойчивости серверов.</span></p></body></html>