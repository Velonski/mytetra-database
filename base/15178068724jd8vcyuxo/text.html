<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; font-weight:600; color:#212529;">Кэширование</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> — это один из способов оптимизации Web приложений. В любом приложении встречаются медленные операции (SQL запросы или запросы к внешним API), результаты которых можно сохранить на некоторое время. Это позволит выполнять меньше таких операций, а большинству пользователей показывать заранее сохраненные данные.</span><img src="image24861.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Наиболее популярная технология кеширования для Web приложений —</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> </span><a href="http://memcached.org/"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; text-decoration: underline; color:#e85f63;">Memcache</span></a><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;">.</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Когда нужно кэшировать</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Старайтесь избегать кэширования, пока в этом не будет прямой необходимости. Это простая техника, но это снижает гибкость приложения. Не делайте лишнюю работу заранее, но закладывайте возможность использования кэширования в будущем:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px;">Используйте классы или функции, для работы с данными. Не используйте повторяющихся SQL выборок в основном приложении.</span></li>
<li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px;">Используйте обертки для работы с внешними API.</span></li></ul>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Что кэшировать?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Кэшировать нужно данные, которые медленно генерируются и часто запрашиваются. На практике это обычно:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px;">Результаты запросов к внешним сервисам (RSS, SOAP, REST и т.п.).</span></li>
<li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px;">Результаты медленных выборок из базы данных.</span></li>
<li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px;">Сгенерированные html блоки либо целые страницы.</span><img src="image8234.png" /></li></ul>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Кэширование выборок из баз данных</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Запросы к базе данных — наиболее распространенный пример. На основе Мemcache реализуется очень просто:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_connect('localhost', 11211);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">function get_online_users()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	if ( </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">!$list = memcache_get('online_users')</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;"> )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$sql = 'SELECT * FROM users WHERE last_visit &gt; UNIX_TIMESTAMP() - 60*10';</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$q = mysql_query($sql);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		while ($row = mysql_fetch_assoc($q)) $list[] = $row;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">memcache_set('online_users', $list, 60*60);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	return $list;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">$list = get_online_users();</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">...</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Запрос на получение пользователей кэшируется на 1 час</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:51px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#333333; background-color:#ffffff;">Обновление данных</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Если Вы кэшируете данные, которые могут обновляться, необходимо очищать кэш после каждого обновления:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_connect('localhost', 11211);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">function get_user($id)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	if ( !$data = memcache_get('user' . $id) )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$sql = 'SELECT * FROM users WHERE id= ' . intval($id);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$q = mysql_query($sql);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$data = mysql_fetch_assoc($q);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		memcache_set('user' . $id, $data, 60*60);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	return $data;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">function save_user($id, $data)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	mysql_query('UPDATE users SET ... WHERE id = ' . intval($id));</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">memcache_delete('user' . $id);</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:51px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#333333; background-color:#ffffff;">Кэширование списков</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Допустим, Вы кэшируете данные каждого пользователя, как в примере, а также их списки (например, список online пользователей). При обновлении данных пользователя, Вы удаляете данные из кэша только для указанного пользователя. Но его данные могут также присутствовать в списке online пользователей, которые тоже лежат в кэше. Сбрасывать списки при каждом обновлении данных любого пользователя не эффективно. Поэтому обычно используют такой подход:</span></p>
<ol style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px;">Кэшируют списки, которые состоят только из ID пользователей.</span></li>
<li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px;">Для вывода списка отправляют отдельный запрос для получения данных каждого пользователя.</span></li></ol>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Реализация выглядит так:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_connect('localhost', 11211);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">function get_online_users()</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	if ( !$list = memcache_get('online_users') )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$sql = 'SELECT </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">id</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;"> FROM users WHERE last_visit &gt; UNIX_TIMESTAMP() - 60*10';</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$q = mysql_query($sql);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		while ($row = mysql_fetch_assoc($q)) </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">$list[] = $row['id']</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		memcache_set('online_users', $list, 60*60);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	return $list;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">$list = get_online_users();</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">foreach ( $list as $id )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	$user = get_user($id);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	...</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Получим список ID пользователей и для каждого из них получим актуальные данные</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Для получения данных сразу нескольких объектов можно использовать</span><a href="https://ruhighload.com/index.php/2009/08/05/memcache-multi-get-%d0%b7%d0%b0%d1%87%d0%b5%d0%bc/"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; text-decoration: underline; color:#e85f63;">Multiget</span></a><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;">.</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Повторные запросы</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Некоторые данные могут запрашиваться несколько раз в рамках одной страницы, например:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;html&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;body&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;h1&gt;&lt;?=htmlspecialchars( </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">get_user( $_SESSION['id'] )['name']</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;"> )?&gt;&lt;/h1&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">Email: &lt;?=</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">get_user( $_SESSION['id'] )['email']</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">?&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;a href=&quot;/&lt;?=</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">get_user( $_SESSION['id'] )['nick']</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">?&gt;&quot;&gt;Моя страница&lt;/a&gt;</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">...</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Каждый вызов</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> </span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; font-weight:600; color:#212529;">get_user()</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> будет получать данные из кэша. Если Memcache стоит на отдельном сервере, это вызовет большой сетевой трафик и задержки.</span><img src="image28267.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Чтобы этого избежать, можно использовать дополнительный кэш внутри самого приложения:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_connect('localhost', 11211);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">function get_user($id)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">global $app_cache;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">	if ( $app_cache['user' . $id] ) return $app_cache['user' . $id];</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	if ( !$data = memcache_get('user' . $id) )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$sql = 'SELECT * FROM users WHERE id= ' . intval($id);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$q = mysql_query($sql);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$data = mysql_fetch_assoc($q);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		memcache_set('user' . $id, $data, 60*60);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">$app_cache['user' . $id] = $data;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	return $data;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">function save_user($id, $data)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">global $app_cache;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	mysql_query('UPDATE users SET ... WHERE id = ' . intval($id));</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	memcache_delete('user' . $id);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">unset($app_cache['user' . $id]);</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">В реальных приложениях, имеет смысл иметь обертку для Memcache с дополнительным кэшом:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">class mem_cache</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	private $inner_cache = [];</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	public static function get( $key )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		if ( array_key_exists($key, $this-&gt;inner_cache) ) return $this-&gt;inner_cache[$key];</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$data = memcache_get( $this-&gt;resource, $key );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$this-&gt;inner_cache[$key] = $data;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		return $data['value'];</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	public static function set( $key, $value, $ttl )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		memcache_set($key, $value, $ttl);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$this-&gt;inner_cache[$key] = $value;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	public static function del( $key )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		memcache_delete($key);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		unset($this-&gt;inner_cache[$key]);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;">#</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888;"> </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#888888; background-color:#eeeeee;">$inner_cache</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888;"> хранит дополнительный кэш</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; font-weight:600; color:#212529;">Внимание.</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> Использование этого подхода может приводить к утечкам памяти в случаях, когда идет работа с большим количеством данных в кэше. Например, в cron-задачах (допустим, мы перебираем всех пользователей для отправки рассылки). Тогда лучше добавить отключение внутреннего кэша:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">class mem_cache</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	private $inner_cache = [];</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">public static $inner_cache_enabled = true;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	public static function get( $key )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		if ( </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">self::$inner_cache_enabled</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;"> &amp;&amp; array_key_exists($key, $this-&gt;inner_cache) ) return $this-&gt;inner_cache[$key];</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$data = memcache_get( $this-&gt;resource, $key );</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$this-&gt;inner_cache[$key] = $data;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		return $data['value'];</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	public static function set( $key, $value, $ttl )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		memcache_set($key, $value, $ttl);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">if ( self::$inner_cache_enabled )</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;"> $this-&gt;inner_cache[$key] = $value;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	public static function del( $key )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		memcache_delete($key);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		unset($this-&gt;inner_cache[$key]);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">...</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">mem_cache::$inner_cache_enabled = false;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Отключаем внутренний кэш</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Подогревание</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">При обновлении особенно тяжелых данных следует использовать не сброс кэша, а прямое обновление данных в нем:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_connect('localhost', 11211);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">function get_rss($id)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	if ( !$data = memcache_get('rss') )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		$data = file_get_contents('http://rss.com/rss');</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">		memcache_set('rss', $data, 60*60);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	return $data;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">function update_rss_feed($id, $data)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	# операции по обновлению внешних ресурсов</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">$data = file_get_contents('http://rss.com/rss');</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">	memcache_set('rss', $data, 60*60);</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Это позволит избежать дополнительной нагрузки при выполнении тяжелых выборок, когда ключ удаляется. Такую методику обычно используют в cron задачах, чтобы периодически обновлять результаты очень тяжелых выборок.</span><img src="image25118.png" /></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><a name="ttl"></a><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">В</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">ремя жизни (ttl)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">ttl (время жизни) — это время, после которого, данные будут удалены из кэша. В Memcache устанавливается в секундах:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_set('rss', $data, </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">60*60</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">);</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Установка ttl на 1 час</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Чаще всего ttl ставят от нескольких минут до нескольких дней. Не используйте значение 0 (бесконечное хранение), это может засорить память.</span><img src="image10641.png" /></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><a name="lru"></a><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">L</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">RU</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Любой кэш работает по принципу вытеснения если ему не хватает памяти. Т.е. если Memcache может использовать максимум 1G памяти, а Вы пытаетесь сохранить ключей на 2G, то половину из этих данных Memcache удалит. Для определения, какие именно ключи удалять, используется алгоритм LRU (Least Recently Used):</span><img src="image29123.png" /></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Memcache постарается удалить прежде всего те данные, которые запрашивались очень давно (т.е. менее популярные удалит, а более популярные оставит).</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Кэширование очень медленных запросов</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Представьте, что у Вас есть запрос, который выполняется 10 секунд. Вы сохраняете его в кэш на 1 час. Когда проходит это время, данные в кэше удаляются. В первые 10 секунд после этого Вы сталкиваетесь с ситуацией, когда несколько пользователей одновременно вызывают этот тяжелейший запрос. Это может привести к катастрофическим последствиям, т.к. в течение 10 секунд может быть несколько сотен или тысяч таких вызовов.</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Чтобы этого избежать, необходимо использовать специальную</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> </span><a href="https://ruhighload.com/index.php/2009/12/02/keshyrovanie-tyajelyh-zaprosov-memcache/"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; text-decoration: underline; color:#e85f63;">методику дублирования</span></a><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;">.</span><img src="image27384.png" /></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Атомарные операции</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Иногда в кэше хранятся счетчики (например, количество пользователей). При добавлении новых пользователей, вместо сброса счетчика и повторной выборки, можно просто увеличить значение кэша на единицу. Но сделать это через приложение нельзя, т.к. это приведет к потере данных от двух одновременно выполненных запросов:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">$count = memcache_get('count');</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">$count++;</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_set('count', $count);</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Memcache поддерживает две атомарные операции увеличения и уменьшения чисел:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_increment('count');</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Увеличит счетчик на 1, функция</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888;"> </span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#888888;">memcache_decrement()</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888;"> уменьшает счетчик</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Самое важное</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Кэширование в приложениях на основе Memcache — это очень сильный инструмент. Не забывайте, что Memcache не гарантирует Вам сохранности данных. Это значит, что нельзя рассчитывать на то, что сохраненные на 60 минут данные будут находиться в кэше именно 60 минут.</span></p></body></html>