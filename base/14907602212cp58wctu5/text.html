<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Понадобилось тут на скорую руку поднять винду на VPS. Хостинг выбрал «облачный» от Оверсана, потому как дают на тестирование при регистрации небольшую денюжку. Если сервер держать выключенным и включать по необходимости, то хватит надолго. Впрочем, и последующая оплата при такой схеме по карману не сильно ударит. Но проблема в том, что в качестве предустановленных систем Windows там, само собой, нет. Эта статья является небольшим, но полным и рабочим пошаговым руководством по установке Windows на VPS под Debian. У других хостеров возможно все будет несколько иначе, но суть та же. </span><a name="habracut"></a><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">Р</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;">егистрируемся, покупаем IP (далее в качестве примера указан 188.127.231.111), создаем сервер с усановленной ОС Debian. Устанавливаем необходимое: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">apt-get update<br />apt-get install mc nano screen qemu bridge-utils vde2</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> создаем тестовый диск на 100M </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">dd if=/dev/zero of=/root/hda.img count=1 bs=100M</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> Пробуем запустить: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">qemu -M pc -m 1024 -win2k-hack -localtime -hda /root/hda.img -boot d -net nic,vlan=0,macaddr=00:ce:53:e9:71:cf -net user,vlan=0 -name &quot;test&quot; -vnc :1</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> Если запустилось, то пробуем получить доступ к консоли нашей виртуальной машины с помощью vncviewer. IP 188.127.231.111, порт 1 Получилось? Отлично, идем дальше. ДНС в /etc/resolv.conf уже прописан, но если изенить настройки сети, то ДНС у нас больше не будет, поэтому сносим пакет: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">apt-get remove --purge resolvconf</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> Нам нужно получить нормальное управление над Windows, для чего прокинем порт 3389 наружу и сделаем NAT, чтобы из Windows был доступ в интернет. Включаем форвардинг: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> Запускаем редактор: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">nano /etc/sysctl.conf </span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> далее ищем строчку #net.ipv4.ip_forward=1 и убираем «решётку» Добавляем правила для НАТа и форвардинга: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">iptables -A FORWARD -i eth0 -o eth1 -s 10.1.1.0/24 -j ACCEPT<br />iptables -A FORWARD -i eth1 -o eth0 -d 10.1.1.0/24 -j ACCEPT<br />iptables -t nat -A POSTROUTING -s 10.1.1.0/24 -o eth1 -j SNAT --to-source 188.127.231.111<br />iptables -A INPUT -s 188.127.231.111 -i eth1 -p tcp -m tcp --dport 3389 -j ACCEPT<br />iptables -A FORWARD -s 188.127.231.111 -i eth1 -p tcp -m tcp --dport 3389 -j ACCEPT<br />iptables -t nat -A PREROUTING -p tcp -i eth1 --dport 3389 -j DNAT --to-destination 10.1.1.2:3389</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> Чтобы при каждом запуске сетевых интерфейсов подгружались правила, сохраним текущие правила </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">iptables-save &gt; /etc/iptables.conf</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> А в файл /etc/network/interfaces, добавим строку загрузки «post-up /sbin/iptables-restore &lt; /etc/iptables.conf» Теперь редактируем файл настроек сети /etc/network/interfaces: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">auto eth0 lo eth1 br0<br /><br />iface lo inet loopback<br /><br />iface eth0 inet static<br />address 0.0.0.0<br /><br />iface eth1 inet static<br />address 188.127.231.111<br />netmask 255.255.255.0<br />gateway 188.127.231.254<br /><br />iface br0 inet static<br />address 10.1.1.1<br />netmask 255.255.255.0<br />bridge_ports eth0<br />bridge_fd 9<br />bridge_hello 2<br />bridge_maxage 12<br />bridge_stp off<br /><br />post-up /sbin/iptables-restore &lt; /etc/iptables.conf</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> В файле /etc/qemu-ifup комментим все Создаем /root/qemu-auto и присваиваем нужные права: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">echo &quot;&quot; &gt; /root/qemu-auto<br />chmod 755 /root/qemu-auto<br />chmod +s /root/qemu-auto</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> В /root/qemu-auto пишем: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">#!/bin/bash<br /><br />sleep 30<br />vde_tunctl -b<br />sleep 1<br />/sbin/ifconfig tap0 0.0.0.0 promisc up<br />sleep 1<br />brctl addif br0 tap0<br />screen -Sdm qemu qemu -M pc -m 1024 -win2k-hack -localtime -cdrom /root/server2003.iso -hda /root/hda.img -boot d -net nic,macaddr=00:ce:53:e9:71:cf -net tap,ifname=tap0 -name &quot;win2k3&quot; -vnc :1</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> И в автозагрузку по крону: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">crontab -e<br />@reboot /root/qemu-auto</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> Качаем откуда-нибудь образ установочного диска с Windows, например так: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">wget http ://myserver/server2003.iso</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> Создаем диск нужного нам размера, мне хватило 5G: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">dd if=/dev/zero of=/root/hda.img count=50 bs=100M</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> И запускаем виртуальную машину: </span><span style=" font-family:'Menlo,Monaco,Courier New,monospace'; font-size:14px; color:#222222; background-color:#ffffff;">./qemu-auto</span><span style=" font-family:'Verdana,sans-serif'; font-size:14px; color:#000000; background-color:#ffffff;"> Дальше должно быть все понятно — с помощью VNC заходим на виртуальную машину (как в тестовом примере выше) и видим привычный экран установки Windows. Я устанавливал систему на пяти слотах (очень шустро, но дорого), потом уменьшил количество до двух — вполне комфортно работается. В этом, кстати, и есть преимущество облачного масштабируемого хостинга. В Windows не забываем настроить сеть — IP 10.1.1.2, маска 255.255.255.0, шлюз 10.1.1.1, днс гуглевский — 8.8.8.8 и 8.8.4.4. Все, мы получили полностью рабочий Windows Server. А, да, не забудьте после установки убрать из строчки запуска &quot;-vnc :1&quot; или заменить на &quot; -vnc 127.0.0.1:1&quot; После перезагрузки все оживет само. Возможно что-то делал не так — дебиан вижу практически в первый раз. Но оно работает и работает так, как мне нужно. Надеюсь, что кому-нибудь пригодится. PS Не сочтите за рекламу хостера — я к ним никакого отношения не имею.</span></p></body></html>