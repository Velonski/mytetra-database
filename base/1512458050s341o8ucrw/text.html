<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">We all know that the performance of applications and web sites is a critical factor in their success. The process of making your application or web site perform better, however, is not always clear. Code quality and infrastructure are of course critical, but in many cases you can make vast improvements to the end user experience of your application by focusing on some very basic application delivery techniques. One such example is by implementing and optimizing caching in your application stack. This blog post covers techniques that can help both novice and advanced users see better performance from utilizing the <a href="https://www.nginx.com/products/content-caching-nginx-plus/"><span style=" text-decoration: underline; color:#0000ff;">content cache features</span></a> included in NGINX.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Overview</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">A content cache sits in between a client and an “origin server”, and saves copies of all the content it sees. If a client requests content that the cache has stored, it returns the content directly without contacting the origin server. This improves performance as the content cache is closer to the client, and more efficiently uses the application servers because they don’t have to do the work of generating pages from scratch each time.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">There are potentially multiple caches between the web browser and the application server: the client’s browser cache, intermediary caches, content delivery networks (CDNs), and the load balancer or reverse proxy sitting in front of the application servers. Caching, even at the reverse proxy/load balancer level, can greatly improve performance.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">As an example, last year I took on the task of performance tuning a website that was loading slowly. One of the first things I noticed was that it took over 1 second to generate the main home page. After some debugging, I discovered that because the page was marked as not cacheable, it was being dynamically generated in response to each request. The page itself was not changing very often and was not personalized, so this was not necessary. As an experiment, I marked the homepage to be cached for 5 seconds by the load balancer, and just doing that resulted in noticeable improvement. The time to first byte went down to a few milliseconds and the page loaded visibly faster.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">NGINX is commonly deployed as a reverse proxy or load balancer in an application stack and has a full set of caching features. The next section discusses how to configure basic caching with NGINX.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">How to Set Up and Configure Basic Caching</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Only two directives are needed to enable basic caching: <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_path</span></a> and <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache</span></a>. The <span style=" font-family:'Courier New,courier';">proxy_cache_path</span> directive sets the path and configuration of the cache, and the <span style=" font-family:'Courier New,courier';">proxy_cache</span> directive activates it.</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_path</span><span style=" font-family:'Courier New,courier';"> /path/to/cache levels=1:2 keys_zone=my_cache:10m max_size=10g</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                 inactive=60m use_temp_path=off;</span></pre>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">server {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    # ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location / {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache</span><span style=" font-family:'Courier New,courier';"> my_cache;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        proxy_pass http://my_upstream;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The parameters to the <span style=" font-family:'Courier New,courier';">proxy_cache_path</span> directive define the following settings:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The local disk directory for the cache is called <span style=" font-weight:600;">/path/to/cache/</span>.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">levels</span> sets up a two‑level directory hierarchy under <span style=" font-weight:600;">/path/to/cache/</span>. Having a large number of files in a single directory can slow down file access, so we recommend a two‑level directory hierarchy for most deployments. If the <span style=" font-family:'Courier New,courier';">levels</span> parameter is not included, NGINX puts all files in the same directory.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">keys_zone</span> sets up a shared memory zone for storing the cache keys and metadata such as usage timers. Having a copy of the keys in memory enables NGINX to quickly determine if a request is a <span style=" font-family:'Courier New,courier';">HIT</span> or a <span style=" font-family:'Courier New,courier';">MISS</span> without having to go to disk, greatly speeding up the check. A 1‑MB zone can store data for about 8,000 keys, so the 10‑MB zone configured in the example can store data for about 80,000 keys.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">max_size</span> sets the upper limit of the size of the cache (to 10 gigabytes in this example). It is optional; not specifying a value allows the cache to grow to use all available disk space. When the cache size reaches the limit, a process called the <span style=" font-style:italic;">cache manager</span> removes the files that were least recently used to bring the cache size back under the limit.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">inactive</span> specifies how long an item can remain in the cache without being accessed. In this example, a file that has not been requested for 60 minutes is automatically deleted from the cache by the cache manager process, regardless of whether or not it has expired. The default value is 10 minutes (<span style=" font-family:'Courier New,courier';">10m</span>). Inactive content differs from expired content. NGINX does not automatically delete content that has expired as defined by a cache control header (<span style=" font-family:'Courier New,courier';">Cache-Control:max-age=120</span> for example). Expired (stale) content is deleted only when it has not been accessed for the time specified by <span style=" font-family:'Courier New,courier';">inactive</span>. When expired content is accessed, NGINX refreshes it from the origin server and resets the <span style=" font-family:'Courier New,courier';">inactive</span> timer.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">NGINX first writes files that are destined for the cache to a temporary storage area, and the <span style=" font-family:'Courier New,courier';">use_temp_path=off</span> directive instructs NGINX to write them to the same directories where they will be cached. We recommend that you set this parameter to <span style=" font-family:'Courier New,courier';">off</span> to avoid unnecessary copying of data between file systems. <span style=" font-family:'Courier New,courier';">use_temp_path</span> was introduced in NGINX version 1.7.10 and <a href="https://www.nginx.com/blog/nginx-plus-r6-released/"><span style=" text-decoration: underline; color:#0000ff;">NGINX Plus R6</span></a>.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">And finally, the <span style=" font-family:'Courier New,courier';">proxy_cache</span> directive activates caching of all content that matches the URL of the parent <span style=" font-family:'Courier New,courier';">location</span> block (in the example, <span style=" font-weight:600;">/</span>). You can also include the <span style=" font-family:'Courier New,courier';">proxy_cache</span> directive in a <span style=" font-family:'Courier New,courier';">server</span> block; it applies to all <span style=" font-family:'Courier New,courier';">location</span> blocks for the server that don’t have their own <span style=" font-family:'Courier New,courier';">proxy_cache</span> directive.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="stale"></a><span style=" font-size:x-large; font-weight:600;">D</span><span style=" font-size:x-large; font-weight:600;">elivering Cached Content When the Origin is Down</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">A powerful feature of NGINX <a href="https://www.nginx.com/products/content-caching-nginx-plus/"><span style=" text-decoration: underline; color:#0000ff;">content caching</span></a> is that NGINX can be configured to deliver stale content from its cache when it can’t get fresh content from the origin servers. This can happen if all the origin servers for a cached resource are down or temporarily busy. Rather than relay the error to the client, NGINX delivers the stale version of the file from its cache. This provides an extra level of fault tolerance for the servers that NGINX is proxying, and ensures uptime in the case of server failures or traffic spikes. To enable this functionality, include the <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_use_stale"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_use_stale</span></a> directive:</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">location / {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    # ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_use_stale</span><span style=" font-family:'Courier New,courier';"> error timeout http_500 http_502 http_503 http_504;</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">With this sample configuration, if NGINX receives an <span style=" font-family:'Courier New,courier';">error</span>, <span style=" font-family:'Courier New,courier';">timeout</span>, or any of the specified <span style=" font-family:'Courier New,courier';">5xx</span> errors from the origin server and it has a stale version of the requested file in its cache, it delivers the stale file instead of relaying the error to the client.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Fine‑Tuning the Cache and Improving Performance</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">NGINX has a wealth of optional settings for fine‑tuning the performance of the cache. Here is an example that activates a few of them:</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">proxy_cache_path /path/to/cache levels=1:2 keys_zone=my_cache:10m max_size=10g</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                 inactive=60m use_temp_path=off;</span></pre>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">server {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    # ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location / {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        proxy_cache my_cache;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_revalidate</span><span style=" font-family:'Courier New,courier';"> on;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_min_uses</span><span style=" font-family:'Courier New,courier';"> 3;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_use_stale</span><span style=" font-family:'Courier New,courier';"> error timeout </span><span style=" font-family:'Courier New,courier'; font-weight:600;">updating</span><span style=" font-family:'Courier New,courier';"> http_500 http_502</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                              http_503 http_504;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_background_update</span><span style=" font-family:'Courier New,courier';"> on;</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_lock</span><span style=" font-family:'Courier New,courier';"> on;</span></pre>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        proxy_pass http://my_upstream;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">These directives configure the following behavior:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_revalidate"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_revalidate</span></a> instructs NGINX to use conditional <span style=" font-family:'Courier New,courier';">GET</span> requests when refreshing content from the origin servers. If a client requests an item that is cached but expired as defined by the cache control headers, NGINX includes the <span style=" font-family:'Courier New,courier';">If-Modified-Since</span> field in the header of the <span style=" font-family:'Courier New,courier';">GET</span> request it sends to the origin server. This saves on bandwidth, because the server sends the full item only if it has been modified since the time recorded in the <span style=" font-family:'Courier New,courier';">Last-Modified</span> header attached to the file when NGINX originally cached it.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_min_uses"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_min_uses</span></a> sets the number of times an item must be requested by clients before NGINX caches it. This is useful if the cache is constantly filling up, as it ensures that only the most frequently accessed items are added to the cache. By default <span style=" font-family:'Courier New,courier';">proxy_cache_min_uses</span> is set to 1.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The <span style=" font-family:'Courier New,courier';">updating</span> parameter to the <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_use_stale"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_use_stale</span></a> directive, combined with enabling the <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_background_update"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_background_update</span></a> directive, instructs NGINX to deliver stale content when clients request an item that is expired or is in the process of being updated from the origin server. All updates will be done in the background. The stale file is returned for all requests until the updated file is fully downloaded.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">With <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_lock"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_lock</span></a> enabled, if multiple clients request a file that is not current in the cache (a <span style=" font-family:'Courier New,courier';">MISS</span>), only the first of those requests is allowed through to the origin server. The remaining requests wait for that request to be satisfied and then pull the file from the cache. Without <span style=" font-family:'Courier New,courier';">proxy_cache_lock</span> enabled, all requests that result in cache misses go straight to the origin server.</li></ul>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Splitting the Cache Across Multiple Hard Drives</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">With NGINX, there’s no need to build a RAID. If there are multiple hard drives, NGINX can be used to split the cache across them. Here is an example that splits clients evenly across two hard drives based on the request URI:</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">proxy_cache_path /path/to/hdd1 levels=1:2 keys_zone=my_cache_hdd1:10m</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                 max_size=10g inactive=60m use_temp_path=off;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">proxy_cache_path /path/to/hdd2 levels=1:2 keys_zone=my_cache_hdd2:10m</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                 max_size=10g inactive=60m use_temp_path=off;</span></pre>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">split_clients $request_uri $my_cache {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">              50%          “my_cache_hdd1”;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">              50%          “my_cache_hdd2”;</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">server {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    # ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location / {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        proxy_cache $my_cache;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        proxy_pass http://my_upstream;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The two <span style=" font-family:'Courier New,courier';">proxy_cache_path</span> directives define two caches (<span style=" font-family:'Courier New,courier';">my_cache_hdd1</span> and <span style=" font-family:'Courier New,courier';">my_cache_hdd2</span>) on two different hard drives. The <a href="http://nginx.org/en/docs/http/ngx_http_split_clients_module.html"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">split_clients</span></a> configuration block specifies that the results from half the requests (<span style=" font-family:'Courier New,courier';">50%</span>) are cached in <span style=" font-family:'Courier New,courier';">my_cache_hdd1</span> and the other half in <span style=" font-family:'Courier New,courier';">my_cache_hdd2</span>. The hash based on the <span style=" font-family:'Courier New,courier';">$request_uri</span> variable (the request URI) determines which cache is used for each request, the result being that requests for a given URI are always cached in the same cache.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Frequently Asked Questions (FAQ)</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">This section answers some frequently asked questions about NGINX content caching.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Can the NGINX Cache Be Instrumented?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Yes, with the <a href="http://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">add_header</span></a> directive:</p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600;">add_header</span><span style=" font-family:'Courier New,courier';"> X-Cache-Status $upstream_cache_status;</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">This example adds an <span style=" font-family:'Courier New,courier';">X-Cache-Status</span> HTTP header in responses to clients. The following are the possible values for <a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#var_upstream_cache_status"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">$upstream_cache_status</span></a>:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">MISS</span> – The response was not found in the cache and so was fetched from an origin server. The response might then have been cached.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">BYPASS</span> – The response was fetched from the origin server instead of served from the cache because the request matched a <span style=" font-family:'Courier New,courier';">proxy_cache_bypass</span> directive (see <a href="https://www.nginx.com/blog/nginx-caching-guide/#caching-guide-faq-hole-punch"><span style=" text-decoration: underline; color:#0000ff;">Can I Punch a Hole Through My Cache?</span></a> below.) The response might then have been cached.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">EXPIRED</span> – The entry in the cache has expired. The response contains fresh content from the origin server.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">STALE</span> – The content is stale because the origin server is not responding correctly, and <span style=" font-family:'Courier New,courier';">proxy_cache_use_stale</span> was configured.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">UPDATING</span> – The content is stale because the entry is currently being updated in response to a previous request, and <span style=" font-family:'Courier New,courier';">proxy_cache_use_stale updating</span> is configured.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">REVALIDATED</span> – The <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_revalidate"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_revalidate</span></a> directive was enabled and NGINX verified that the current cached content was still valid (<span style=" font-family:'Courier New,courier';">If-Modified-Since</span> or <span style=" font-family:'Courier New,courier';">If-None-Match</span>).</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">HIT</span> – The response contains valid, fresh content direct from the cache.</li></ul>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">How Does NGINX Determine Whether or Not to Cache Something?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">By default, NGINX respects the <span style=" font-family:'Courier New,courier';">Cache-Control</span> headers from origin servers. It does not cache responses with <span style=" font-family:'Courier New,courier';">Cache-Control</span> set to <span style=" font-family:'Courier New,courier';">Private</span>, <span style=" font-family:'Courier New,courier';">No-Cache</span>, or <span style=" font-family:'Courier New,courier';">No-Store</span> or with <span style=" font-family:'Courier New,courier';">Set-Cookie</span> in the response header. NGINX only caches <span style=" font-family:'Courier New,courier';">GET</span> and <span style=" font-family:'Courier New,courier';">HEAD</span> client requests. You can override these defaults as described in the answers below.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">NGINX does not cache responses if <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffering"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_buffering</span></a> is set to <span style=" font-family:'Courier New,courier';">off</span>. It is <span style=" font-family:'Courier New,courier';">on</span> by default.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Can </span><span style=" font-family:'Courier New,courier'; font-size:large; font-weight:600;">Cache-Control</span><span style=" font-size:large; font-weight:600;"> Headers Be Ignored?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Yes, with the <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ignore_headers"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_ignore_headers</span></a> directive. For example, with this configuration:</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">location /images/ {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    proxy_cache my_cache;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_ignore_headers</span><span style=" font-family:'Courier New,courier';"> Cache-Control;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_valid</span><span style=" font-family:'Courier New,courier';"> any 30m;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    # ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">NGINX ignores the <span style=" font-family:'Courier New,courier';">Cache-Control</span> header for everything under <span style=" font-weight:600;">/images/</span>. The <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_valid"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_valid</span></a> directive enforces an expiration for the cached data and is required if ignoring <span style=" font-family:'Courier New,courier';">Cache-Control</span> headers. NGINX does not cache files that have no expiration.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Can NGINX Cache Content with a </span><span style=" font-family:'Courier New,courier'; font-size:large; font-weight:600;">Set-Cookie</span><span style=" font-size:large; font-weight:600;"> in the Header?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Yes, with the <span style=" font-family:'Courier New,courier';">proxy_ignore_headers</span> directive, as discussed in the previous answer.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Can NGINX Cache </span><span style=" font-family:'Courier New,courier'; font-size:large; font-weight:600;">POST</span><span style=" font-size:large; font-weight:600;"> Requests?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Yes, with the <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_methods"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_methods</span></a> directive:</p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_methods</span><span style=" font-family:'Courier New,courier';"> GET HEAD POST;</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">This example enables caching of <span style=" font-family:'Courier New,courier';">POST</span> requests.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Can NGINX Cache Dynamic Content?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Yes, provided the <span style=" font-family:'Courier New,courier';">Cache-Control</span> header allows for it. Caching dynamic content for even a short period of time can reduce load on origin servers and databases, which improves time to first byte, as the page does not have to be regenerated for each request.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="caching-guide-faq-hole-punch"></a><span style=" font-size:large; font-weight:600;">C</span><span style=" font-size:large; font-weight:600;">an I Punch a Hole Through My Cache?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Yes, with the <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_bypass"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_bypass</span></a> directive:</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">location / {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_bypass</span><span style=" font-family:'Courier New,courier';"> $cookie_nocache $arg_nocache;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    # ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The directive defines request types for which NGINX requests content from the origin server immediately instead of trying to find it in the cache first. This is sometimes referred to as “punching a hole” through the cache. In this example, NGINX does it for requests with a <span style=" font-family:'Courier New,courier';">nocache</span> cookie or argument, for example <span style=" font-family:'Courier New,courier';">http://www.example.com/?nocache=true</span>. NGINX can still cache the resulting response for future requests that aren’t bypassed.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">What Cache Key Does NGINX Use?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The default form of the keys that NGINX generates is similar to an MD5 hash of the following <a href="http://nginx.org/en/docs/varindex.html"><span style=" text-decoration: underline; color:#0000ff;">NGINX variables</span></a>: <span style=" font-family:'Courier New,courier';">$scheme$proxy_host$request_uri</span>; the actual algorithm used is slightly more complicated.</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">proxy_cache_path /path/to/cache levels=1:2 keys_zone=my_cache:10m max_size=10g</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">                 inactive=60m use_temp_path=off;</span></pre>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">server {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    # ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    location / {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        proxy_cache my_cache;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">        proxy_pass http://my_upstream;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    }</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">For this sample configuration, the cache key for <span style=" font-family:'Courier New,courier';">http://www.example.org/my_image.jpg</span> is calculated as <span style=" font-family:'Courier New,courier';">md5(“http://my_upstream:80/my_image.jpg”)</span>.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Note that <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#var_proxy_host"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">$proxy_host</span></a> variable is used in the hashed value instead of the actual host name (<span style=" font-family:'Courier New,courier';">www.example.com</span>). <span style=" font-family:'Courier New,courier';">$proxy_host</span> is defined as the name and port of the proxied server as specified in the <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_pass</span></a> directive.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">To change the variables (or other terms) used as the basis for the key, use the <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_key"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_key</span></a> directive (see also the following question).</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Can I Use a Cookie as Part of My Cache Key?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Yes, the cache key can be configured to be any arbitrary value, for example:</p>
<pre style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_key</span><span style=" font-family:'Courier New,courier';"> $proxy_host$request_uri$cookie_jessionid;</span></pre>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">This example incorporates the value of the <span style=" font-family:'Courier New,courier';">JSESSIONID</span> cookie into the cache key. Items with the same URI but different <span style=" font-family:'Courier New,courier';">JSESSIONID</span> values are cached separately as unique items.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Does NGINX Use the </span><span style=" font-family:'Courier New,courier'; font-size:large; font-weight:600;">ETag</span><span style=" font-size:large; font-weight:600;"> Header?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">In NGINX 1.7.3 and <a href="https://www.nginx.com/blog/nginx-plus-r5-released/"><span style=" text-decoration: underline; color:#0000ff;">NGINX Plus R5</span></a> and later, the <span style=" font-family:'Courier New,courier';">ETag</span> header is fully supported along with <span style=" font-family:'Courier New,courier';">If-None-Match</span>.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">How Does NGINX Handle Byte Range Requests?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">If the file is up‑to‑date in the cache, then NGINX honors a byte range request and serves only the specified bytes of the item to the client. If the file is not cached, or if it’s stale, NGINX downloads the entire file from the origin server. If the request is for a single byte range, NGINX sends that range to the client as soon as it is encountered in the download stream. If the request specifies multiple byte ranges within the same file, NGINX delivers the entire file to the client when the download completes.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Once the download completes, NGINX moves the entire resource into the cache so that all future byte‑range requests, whether for a single range or multiple ranges, are satisfied immediately from the cache.</p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Please note that the <span style=" font-family:'Courier New,courier';">upstream</span> server must support byte range requests for NGINX to honor byte range requests to that <span style=" font-family:'Courier New,courier';">upstream</span> server.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Does NGINX Support Cache Purging?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://www.nginx.com/products"><span style=" text-decoration: underline; color:#0000ff;">NGINX Plus</span></a> supports selective purging of cached files. This is useful if a file has been updated on the origin server but is still valid in the NGINX Plus cache (the <span style=" font-family:'Courier New,courier';">Cache-Control:max-age</span> is still valid and the timeout set by the <span style=" font-family:'Courier New,courier';">inactive</span> parameter to the <span style=" font-family:'Courier New,courier';">proxy_cache_path</span> directive has not expired). With the cache‑purge feature of NGINX Plus, this file can easily be deleted. For more details, see <a href="https://www.nginx.com/products/content-caching-nginx-plus/#purging"><span style=" text-decoration: underline; color:#0000ff;">Purging Content from the Cache</span></a>.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">How Does NGINX Handle the </span><span style=" font-family:'Courier New,courier'; font-size:large; font-weight:600;">Pragma</span><span style=" font-size:large; font-weight:600;"> Header?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The <span style=" font-family:'Courier New,courier';">Pragma:no-cache</span> header is added by clients to bypass all intermediary caches and go straight to the origin server for the requested content. NGINX does not honor the <span style=" font-family:'Courier New,courier';">Pragma</span> header by default, but you can configure the feature with the following <span style=" font-family:'Courier New,courier';">proxy_cache_bypass</span> directive:</p>
<pre style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">location /images/ {</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    proxy_cache my_cache;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    </span><span style=" font-family:'Courier New,courier'; font-weight:600;">proxy_cache_bypass</span><span style=" font-family:'Courier New,courier';"> $http_pragma;</span></pre>
<pre style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">    # ...</span></pre>
<pre style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier';">}</span></pre>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Does NGINX Support the </span><span style=" font-family:'Courier New,courier'; font-size:large; font-weight:600;">stale-while-revalidate</span><span style=" font-size:large; font-weight:600;"> and </span><span style=" font-family:'Courier New,courier'; font-size:large; font-weight:600;">stale-if-error</span><span style=" font-size:large; font-weight:600;"> extensions to the </span><span style=" font-family:'Courier New,courier'; font-size:large; font-weight:600;">Cache-Control</span><span style=" font-size:large; font-weight:600;"> header?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Yes, in <a href="https://www.nginx.com/blog/nginx-plus-r12-released/"><span style=" text-decoration: underline; color:#0000ff;">NGINX Plus R12</span></a> and NGINX 1.11.10 and later. What these extensions do:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The <a href="https://tools.ietf.org/html/rfc5861#section-3"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">stale-while-revalidate</span></a> extension of the <span style=" font-family:'Courier New,courier';">Cache-Control</span> HTTP header permits using a stale cached response if it is currently being updated.</li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;">The <a href="https://tools.ietf.org/html/rfc5861#section-4"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">stale-if-error</span></a> extension of the <span style=" font-family:'Courier New,courier';">Cache-Control</span> HTTP header permits using a stale cached response in case of an error. </p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">These headers have lower priority than the <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_use_stale"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">proxy_cache_use_stale</span></a> directive <a href="https://www.nginx.com/blog/nginx-caching-guide/#stale"><span style=" text-decoration: underline; color:#0000ff;">described above</span></a>.</p>
<p style=" margin-top:14px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:large; font-weight:600;">Does NGINX Support the </span><span style=" font-family:'Courier New,courier'; font-size:large; font-weight:600;">Vary</span><span style=" font-size:large; font-weight:600;"> header?</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Yes, in <a href="https://www.nginx.com/blog/nginx-plus-r5-released/"><span style=" text-decoration: underline; color:#0000ff;">NGINX Plus R5</span></a> and NGINX 1.7.7 and later. Here is a <a href="https://www.fastly.com/blog/best-practices-for-using-the-vary-header/"><span style=" text-decoration: underline; color:#0000ff;">good overview of the </span></a><a href="https://www.fastly.com/blog/best-practices-for-using-the-vary-header/"><span style=" font-family:'Courier New,courier'; text-decoration: underline; color:#0000ff;">Vary</span></a><a href="https://www.fastly.com/blog/best-practices-for-using-the-vary-header/"><span style=" text-decoration: underline; color:#0000ff;"> header</span></a>.</p>
<p style=" margin-top:16px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:x-large; font-weight:600;">Further Reading</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">There are many more ways you can customize and tune NGINX caching. To learn even more about caching with NGINX, please take a look at the following resources:</p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html"><span style=" text-decoration: underline; color:#0000ff;">ngx_http_proxy_module</span></a> section of the of the NGINX documentation contains all of the configuration options for content caching.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">Two NGINX content caching webinars are available on demand (<a href="https://www.nginx.com/resources/webinars/content-caching-nginx-plus/"><span style=" text-decoration: underline; color:#0000ff;">option 1</span></a>, <a href="https://www.nginx.com/resources/webinars/high-availability-content-caching-nginx/"><span style=" text-decoration: underline; color:#0000ff;">option 2</span></a>). These webinars step through much of the information presented in this blog post.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The <a href="https://www.nginx.com/resources/admin-guide/content-caching/"><span style=" text-decoration: underline; color:#0000ff;">Content Caching</span></a> section of the NGINX Plus Admin Guide has more configuration examples and information on tuning the NGINX cache.</li>
<li style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The <a href="https://www.nginx.com/products/content-caching-nginx-plus/"><span style=" text-decoration: underline; color:#0000ff;">Content Caching with NGINX Plus</span></a> product page contains an overview on how to configure cache purging with NGINX Plus and provides other examples of cache customization.</li>
<li style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">The <a href="https://www.nginx.com/resources/library/high-performance-caching-with-nginx-and-nginx-plus/"><span style=" text-decoration: underline; color:#0000ff;">High Performance Caching with NGINX and NGINX Plus</span></a> ebook provides a thorough deep-dive on NGINX content caching. </li></ul></body></html>