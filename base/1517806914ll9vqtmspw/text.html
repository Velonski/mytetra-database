<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">При</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> </span><a href="https://ruhighload.com/post/%D0%9A%D1%8D%D1%88%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5+%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; text-decoration: underline; color:#e85f63;">кэшировании</span></a><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> особо тяжелых запросов, которые выполняются более нескольких секунд, может возникнуть большая проблема. Если время кэша подойдет к концу, таких тяжелых запросов может быть выполнено сразу несколько, а не один. Например:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_connect('localhost', 11211);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">if ( !$list = memcache_get('user_ages') )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">$sql = 'SELET count(*), age FROM users GROUP BY age';</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	$q = mysql_query($sql);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	while ($row = mysql_fetch_assoc($q)) $list[] = $row;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	memcache_set('user_ages', $list, 60*60);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">...</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Обычное кэширование тяжелого запроса с помощью Memcache</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Представим, что такой SQL запрос будет выполняться 10 секунд. Если в кэше ничего не будет, то первый вызов приведет к тому, что будет выполнен выделенный код:</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_connect('localhost', 11211);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">if ( !$list = memcache_get('user_ages') )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">$sql = 'SELET count(*), age FROM users GROUP BY age';</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">	$q = mysql_query($sql);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">	while ($row = mysql_fetch_assoc($q)) $list[] = $row;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">	memcache_set('user_ages', $list, 60*60);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">...</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Пройдет 10 секунд с начала запроса до сохранения результата в кэш</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Пройдет 10 секунд до того момента, как результат запроса будет сохранен в кэш. Это значит, что в течение 10 секунд любое посещение страницы с этим запросом будет выполнять SQL запрос (т.к. в кэше еще ничего не будет). Это может привести к катастрофическим последствиям, если это происходит в час пик. Каждый новый запрос будет замедлять выполнение предыдущего, т.к. нагрузка на базу будет расти.</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Решение</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Чтобы избавиться от подобных проблем, необходимо использовать методику дублирования ключей. Для каждого тяжелого запроса создается не один, а два ключа:</span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px;">Основной ключ. После выполнения запроса сюда сохраняется результат со стандартным ttl (в примере: 1 час).</span></li>
<li style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-size:20px;">Дополнительный ключ. Сюда сохраняется результат запроса, но ttl устанавливается больше, чем у основного ключа. Больше на время выполнения запроса плюс небольшой запас (в примере: 1 час кэша + 10 секунд запроса + 5 секунд запаса).</span><img src="image6317.png" /></li></ul>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">В момент, когда в кэше удаляются данные, необходимо сначала записать в основной ключ значение из запасного, а только потом приступить к выполнению SQL запроса.</span></p>
<p style=" margin-top:20px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">&lt;?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">memcache_connect('localhost', 11211);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">if ( !$list = memcache_get('user_ages') )</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">{</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">memcache_set('user_ages', memcache_get('user_ages_backup'), 60*60);</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	$sql = 'SELET count(*), age FROM users GROUP BY age';</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	$q = mysql_query($sql);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	while ($row = mysql_fetch_assoc($q)) $list[] = $row;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	memcache_set('user_ages', $list, 60*60);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">	</span><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; font-weight:600; color:#adff2f;">memcache_set('user_ages_backup', $list, 60*60 + 10 + 5);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa; background-color:#212529;"><br /></p>
<p style=" margin-top:0px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:18px; background-color:#212529;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#aaaaaa;">...</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Monaco,Courier New,Courier,mono'; font-size:8.25pt; color:#888888; background-color:#ffffff;"># Сначала записываем данные из запасного ключа в основной</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Таким образом, более одного запроса параллельно выполнено не будет.</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Другие решения</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Также можно использовать cron задачи для обновления данных в кэше. Тогда посетители никогда не смогут вызвать тяжелые запросы. Но в этом случае лучше использовать постоянные хранилища для кэширования (например Redis), т.к. Memcache не гарантирует сохранности данных.</span></p>
<p style=" margin-top:40px; margin-bottom:20px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:60px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Самое важное</span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#ffffff;"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529; background-color:#ffffff;">Эту методику лучше применять для избавления от возможных критических ситуаций. Но крайне желательно избавляться от подобных запросов, оптимизируя</span><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;"> </span><a href="https://ruhighload.com/index.php/2009/07/28/maatkit-%d1%80%d0%b0%d1%81%d1%88%d0%b8%d1%80%d0%b5%d0%bd%d0%bd%d1%8b%d0%b5-%d0%b2%d0%be%d0%b7%d0%bc%d0%be%d0%b6%d0%bd%d0%be%d1%81%d1%82%d0%b8-mysql/"><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; text-decoration: underline; color:#e85f63;">сами запросы</span></a><span style=" font-family:'Georgia,Cambria,Times New Roman,Times,serif'; font-size:8.25pt; color:#212529;">. Помимо SQL запросов, этот же подход можно применять и для внешних API запросов.</span></p></body></html>