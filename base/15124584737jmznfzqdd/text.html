<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="post_202290"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">С</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">уществует мнение, что nginx — отличный инструмент для отдачи статики.<br />Есть статьи, где описываются настройки sendfile или </span><a href="http://habrahabr.ru/post/68480/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">aio</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> для «улучшения» отдачи.<br />На Хабре есть чего почитать о настройке proxy_store с proxy_cache для минимизации проблем со стороны мозгов сайта.<br />Еще в QA иногда возникают вопросы про </span><a href="http://habrahabr.ru/qa/32141/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">кеширование картинок</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">, например.<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Зачем заниматься этой ерундой! — говорят опытные пользователи — OS лучше вас знает как кешировать файлы! С кешем и префетчем в современных OS, точнее FS, проблем нет! Зачем плодить свои кеши и списки популярных материалов и все такое?...</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Есть только одно вредное </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">«но»</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> — в среде исполнения nginx (в общем случае Linux) понятие &quot;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">файл</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">&quot; и вообще «файловая система» — </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">просто понятие</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">.<br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">И однажды, когда я, подмонтировав сервер по sshfs, обновил один скриптик, случилось волшебное:<br />1. На каждой страничке стало на 4 картинки больше.<br />2. Сервера сдохли.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Что поделать — картинки хранились на glusterFS. Наступил полный FUSE.<br /></span><a name="habracut"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">GlusterFS, как и интерфейс FUSE, сильно сжирает производительность, но </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline;">он того стоит</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">.<br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">Изначально у нас был один сервер. Потом два, второй из который монтировал www с первого по nfs. Потом три, четыре. <br />Не очень надежно, но так уж исторически сложилось. Для спасения ситуации нужна была некая совершенно прозрачная система, in-place замена nfs. Кластерная ФС.<br />Сейчас на всех серверах стоит raid 10, и за полтора года эксплуатации он пару раз падал. В том числе совсем. Gluster молча поднимал копию ФС на новой железяке и все продолжало работать. Гластер свою работу знает.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:4px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Но на самом деле история начиналось немного не так. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Причина была другая, но решения проблем будет совпадать.<br />Нет ничего страшнее чем то что &quot;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">исторически сложилось</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">&quot;.<br />И в одном моем проекте «исторически сложилась» ситуация, когда картинки отдает php. <br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">В свое время нужно было сделать файловый загрузчик с различными ACL, ресайзами и вотермарками. Это было почти 10 лет назад. Механизм прижился и с тех пор не менялся.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Сейчас для решения таких проблем есть много специализированных решений(</span><a href="http://habrahabr.ru/company/yandex/blog/200080/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">elliptics</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">, </span><a href="http://habrahabr.ru/post/184652/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">backpack</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> и другие; а еще лучше CDN). Но тратить человекомесяцы на переход не хочется. Спать хочется, а не работать.<br />Да и php чтука, в принципе, неплохая. Но имеет свои пределы.<br /></span></p>
<p style=" margin-top:12px; margin-bottom:4px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Но проблема тормозных бэкендов решена</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Хабр, в очередной раз подсказал вариант решения — </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline;">proxy_store</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> и </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline;">proxy_cache</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">.<br />Но proxy_store использовать мне нельзя — сохранить негде, и с proxy_cache тоже проблемы.<br />Есть одно, большое такое, «но» — много лет назад я уже столкнулся с производительностью отдачи файлов и решил «пускай лучше nginx отдает конечные файлы за меня». <br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">X-Accel-Redirect.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Проблема — nginx не может закешировать ответ из прокси если это не ответ, а команда. </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline;">X-Accel-Redirect — не кешируется</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">.<br />Выхода нет?<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:4px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Исходную проблему зафиксировали</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Теперь вернемся к началу топика.<br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">Нам нужно отдать статику, на этот раз без вмешательства «умных» бэкэндов. Просто статику, но с glusterfs. <br />Директив для кеширования статики просто нет — не предусмотрены. Считается что OS сама не дура. Для статики есть только open_file_cache и настройка самой передачи файлов(sendfile/aio и компания).</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Что делать?<br />Усложним задачу, и попробуем решить проблему исключительно средствами nginx, не внося никаких изменений в другие коды.<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">обычный конфиг</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"># Static files location</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">location ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|swf|txt|ico)$ {             </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    root   /var/www/kashey;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Пропатченый конфиг</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Nginx делает proxy_pass сам на себя, кешируя результат. Возможно тут можно использовать fcgi, но так — нагляднее.<br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"># Static files location</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">location ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|swf|txt|ico)$ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    set $dopass 1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    proxy_set_header   Host             $host;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    #если у нас есть &quot;кука&quot; - отдаем файл с реальной ФС</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    if ($http_fiberpass) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        root   /var/www/kashey;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        #или proxy_pass на бэкэнд</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        set $dopass 0;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        break; #но этот break не работает</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    #настройки кеширования, не забудьте описать proxy_cache_valid</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    proxy_cache static_cache;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    #добавляем прокси &quot;куку&quot;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    proxy_set_header fiberpass &quot;nginx&quot;;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    if ($dopass) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        #отправляем запрос к самому себе.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        proxy_pass		http://127.0.0.1:80;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />И никакой магии.<br />В случае с X-Accel-Redirect схема такая:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">1. nginx получается запрос<br />2. пересылает себе, к сожалению запрос полный и реальный.<br />3. пересылает на прокси<br />4. получает ответ и отдает файл<br />5. ответ кешируется<br />6. ???<br />7. PROFIT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />В случае с обычной статикой сложнее — root не заканчивает выполнение, break и return также не работают. Настройка прокси не может находиться внутри условного блока.<br /></span></p>
<p style=" margin-top:12px; margin-bottom:4px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">Что это дает?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />В смысле с X-Accel-Redirect с apache снимается вал запросов. На загруженной системе разница может составить 50 раз.<br />Но это понятно — php сам по себе, а через апач тем более, не самое реактивное решение. <br />Latenсy запроса меньше 40мс, лично у меня, не получался (общее время php+gluster).<br />В случае использования варианта с proxy_cache скорость отдачи приравнивается к скорости отдачи статики.<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:4px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">А что со статикой?</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Отдача с gluster — 13мс — это нормальное время для системы без кеша.<br /></span><img src="image26314.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> <br /><br />Отдача из кеша — 1мс — это замечательное.<br /></span><img src="image18.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /><br />Важно учесть — сервера находятся в Германии, а клиенты в России.<br />Нормальные пинги до сайта 60-100мс. <br />Так что для клиента ускорение практически не заметно.<br /><br />Но оно заметно для сервера.<br />1. Снизилась нагрузка на сервера, в том числе в попугаях Load average и soft-irq.<br />2. Снизился трафик между серверами (можно решить включив WORM(Write Once Read Many volume), но это уже не «прозрачно»).<br /></span><img src="image21362.png" /><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />3. Все стало работать чуть быстрее. <br /><br />В итоге работы которые на 10% снизили скорость реакции на клиенте, получились в результате 10-ти кратного ускорения отдачи статики. Что снизило общую нагрузку на сервера примерно раз в 20.<br />Обратное утверждение, к сожалению, тоже будет верно — сколько не старайся, клиент может и не заметить.<br /><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">PS: Многие знакомые сисадмины даже не допускали мысли о возможности работы такой схемы. Не позволяет кешировать/проксировать — значит нельзя.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /><br />Хорошие программисты не всегда хорошие сисадмины, а сисадмины, обычно, вообще не программисты.<br />Настоящие герои всегда идут в обход, в брод, и на велосипедах.<br /><br /></span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">PPS: я, кстати, не сисадмин. И, быть может, все сделал не правильно.</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:8px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Метки: </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/search/?q=%5Bnginx%5D&amp;target_type=posts"><span style=" text-decoration: underline; color:#0000ff;">nginx</span></a> </li>
<li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/search/?q=%5B%D0%BA%D0%B5%D1%88%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%5D&amp;target_type=posts"><span style=" text-decoration: underline; color:#0000ff;">кеширование</span></a> </li>
<li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:30px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/search/?q=%5Bfuse%5D&amp;target_type=posts"><span style=" text-decoration: underline; color:#0000ff;">fuse</span></a> </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">AdBlock похитил этот баннер, но баннеры не зубы — отрастут<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://tmtm.ru/services/advertising/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">Реклама</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:36px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;">Читают сейчас </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;" style=" margin-top:12px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a name="broadcast_most-read"></a><a href="https://habrahabr.ru/post/343738/"><span style=" text-decoration: underline; color:#0000ff;">Р</span></a><span style=" text-decoration: underline; color:#0000ff;">азбираемся, что же там нового открыли в задаче о ферзях</span> </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;">15,7k </span><a href="https://habrahabr.ru/post/343738/#comments"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff; vertical-align:top;">28 </span></a></p>
<li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;" style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/post/343116/"><span style=" text-decoration: underline; color:#0000ff;">Как я написал приложение, которое за 15 минут делало тоже самое, что и регулярное выражение за 5 дней</span></a> </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;">5,9k </span><a href="https://habrahabr.ru/post/343116/#comments"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff; vertical-align:top;">26 </span></a></p>
<li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;" style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/post/343808/"><span style=" text-decoration: underline; color:#0000ff;">Где моя оплата? Как мошенники зарабатывают на фрилансерах</span></a> </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;">22,4k </span><a href="https://habrahabr.ru/post/343808/#comments"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff; vertical-align:top;">61 </span></a></p>
<li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;" style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/post/343912/"><span style=" text-decoration: underline; color:#0000ff;">Стоит ли свое хобби развить в стартап?</span></a> </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;">1,2k </span><a href="https://habrahabr.ru/post/343912/#comments"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff; vertical-align:top;">9 </span></a></p>
<li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;" style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/post/343906/"><span style=" text-decoration: underline; color:#0000ff;">Не было печали, апдейтов накачали</span></a> </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;">3,6k </span><a href="https://habrahabr.ru/post/343906/#comments"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff; vertical-align:top;">15 </span></a></p>
<li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;" style=" margin-top:0px; margin-bottom:12px; margin-left:36px; margin-right:36px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/post/343858/"><span style=" text-decoration: underline; color:#0000ff;">Обзор услуги виртуальный рабочий стол</span></a> </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:36px; margin-right:36px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; vertical-align:top;">4,1k </span><a href="https://habrahabr.ru/post/343858/#comments"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff; vertical-align:top;">4 </span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">AdBlock похитил этот баннер, но баннеры не зубы — отрастут<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://tmtm.ru/services/advertising/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">Реклама</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style="-qt-paragraph-type:empty; margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><br /></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+26 </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">25,4k </li>
<li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/post/202290/#comments"><span style=" text-decoration: underline; color:#0000ff;">23 </span></a></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image24096.png" /><a href="https://habrahabr.ru/users/kashey/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;"> </span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">35,0 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Карма </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">6,5 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Рейтинг </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/users/kashey/subscription/followers/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">34 </span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/users/kashey/subscription/followers/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">Подписчики </span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://habrahabr.ru/users/kashey/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">Корзунов Антон</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span><a href="https://habrahabr.ru/users/kashey/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">kashey</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">javascript, webgl, maps, databases </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Поделиться публикацией </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Похожие публикации </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">6 июня 2010 в 11:29 <a href="https://habrahabr.ru/post/95613/"><span style=" text-decoration: underline; color:#0000ff;">Кеширование блоков с помощью nginx</span></a> </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+98 11,1k 327 </span><a href="https://habrahabr.ru/post/95613#comments"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">63 </span></a></p>
<li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">25 ноября 2009 в 09:16 <a href="https://habrahabr.ru/post/76315/"><span style=" text-decoration: underline; color:#0000ff;">nginx, ещё раз про кэширование</span></a> </li>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+45 9,5k 172 </span><a href="https://habrahabr.ru/post/76315#comments"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">27 </span></a></p>
<li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;">23 марта 2009 в 23:13 <a href="https://habrahabr.ru/post/55309/"><span style=" text-decoration: underline; color:#0000ff;">NGINX научился кешировать проксированные запросы</span></a> </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+47 1,5k 31 </span><a href="https://habrahabr.ru/post/55309#comments"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">47 </span></a></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">AdBlock похитил этот баннер, но баннеры не зубы — отрастут<br /><br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a href="https://tmtm.ru/services/advertising/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">Реклама</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comments"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">К</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">омментарии </span><a name="comments_count"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">2</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">3</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image18523.png" /><a name="comment_6984792"></a><a href="https://habrahabr.ru/users/Aecktann/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/Aecktann/"><span style=" text-decoration: underline; color:#0000ff;">Aecktann </span></a>15.11.13 в 17:19 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+11 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6984792"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">i</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">f'ы зло.<br />Рекомендуется использовать if только в случае если вы из него уходите (rewrite last, 30x redirect и т.п.). Это логично и это почти никогда не сломается в случае изменения логики в работе сервера.<br /></span></p>
<p style=" margin-top:12px; margin-bottom:12px; margin-left:40px; margin-right:40px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Use try_files if it suits your needs. Use the «return ...» or «rewrite… last» in other cases. In some cases it's also possible to move ifs to server level (where it's safe as only other rewrite module directives are allowed within it).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /><br />Альтернативный вариант (на мой взгляд лучше читается):<br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    listen 127.0.0.1:80;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    server_name nocache.domain.tld;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    location ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|swf|txt|ico)$ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        allow 127.0.0.1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        deny all;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        root /path/to/fuse/filesystem;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    listen 80;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    server_name domain.tld</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    location ~* ^.+\.(jpg|jpeg|gif|png|ico|css|js|swf|txt|ico)$ {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        proxy_cache static_cache;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        proxy_cache_valid 200 1y;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        proxy_set_header Host nocache.$host;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        proxy_pass http://127.0.0.1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image24780.png" /><a name="comment_6984802"></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;">kashey </span></a>15.11.13 в 17:22 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+2 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6984802"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">С</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">тоит признать — элегантнее. </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image28739.png" /><a name="comment_6985106"></a><a href="https://habrahabr.ru/users/alekciy/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/alekciy/"><span style=" text-decoration: underline; color:#0000ff;">alekciy </span></a>15.11.13 в 18:15 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+2 </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985106"></a>Да тут даже дело не в элегантности. Практика распределения через location-ы, а не регулярки сложилась не просто так. Так быстрее. Ну и смотрится логичнее. </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985014"></a><a href="https://habrahabr.ru/users/ToSHiC/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">T</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">oSHiC</span><a href="https://habrahabr.ru/users/ToSHiC/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;"> </span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">15.11.13 в 17:56 </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+6 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985014"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">В</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">место<br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        allow 127.0.0.1;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        deny all;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />лучше писать<br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        internal;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /><br />Ну а вообще, конечно, отдавать картинки через X-Accel-Redirect, а потом наворачивать поверх конфиги для нгинкса… Мсье (автор, не вы) знает толк в извращениях. </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image24780.png" /><a name="comment_6985112"></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;">kashey </span></a>15.11.13 в 18:16 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">0 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985112"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Т</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">ак </span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">исторически сложилось</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> — мне на вход приходит номер, я его преобразую в имя файла и выплевываю.<br />Когда я делал похожую систему для gdetotdom.ru — админ меня сразу завернул(</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-style:italic;">«нет, давай лучше так делать не будем»</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">).<br />И там nginx «канонически» работает через try_files.<br />Если бы я научился считать md5 в nginxе — смог бы делал тоже самое. Но не научился.<br /><br /></span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985576"></a><a href="https://habrahabr.ru/users/ToSHiC/"><span style=" text-decoration: underline; color:#0000ff;">T</span></a><span style=" text-decoration: underline; color:#0000ff;">oSHiC</span><a href="https://habrahabr.ru/users/ToSHiC/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a>15.11.13 в 20:12 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+1 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985576"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">В</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">ы про штуки типа </span><a href="https://github.com/simpl/ngx_http_set_hash"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">github.com/simpl/ngx_http_set_hash</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">?<br /><br />Можно даже сделать средствами перла, ничего не добавляя в стандартную сборку:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">perl_set $md5 '</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    use Digest::MD5 qw(md5_hex);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    sub {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        my $r = shift;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        my $some_var = $r-&gt;variable(&quot;some_var&quot;);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        return md5_hex($some_var);</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">';</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">server {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    listen 8081;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    location / {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        set $some_var $arg_text;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">        return 200 $md5;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    }</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /><br />Но всё это не отменяет того, что стоит переписать код, который формирует ссылки на картинки. </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image24780.png" /><a name="comment_6985612"></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;">kashey </span></a>15.11.13 в 20:25 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">0 </span></p>
<ul type="circle" style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 2;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985612"></a>Я вот все перлом хочу, и все никак не сделаю.<br />В принципе осталось узнать как substr сделать и можно будет переходить на try_files.<br />Хотя у wikimapia это, в итоге, не получилось — на их объемах try_files тупит.<br />Выкрутились хитро, быть может расскажут когда-нибудь. </li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image18523.png" /><a name="comment_6985766"></a><a href="https://habrahabr.ru/users/Aecktann/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/Aecktann/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">Aecktann </span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">15.11.13 в 21:27 </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+1 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985766"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">З</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">десь нельзя написать internal, потому что это не внутреннее перенаправление и не реврайт. Это прокси само на себя, с точки зрения nginx запрос абсолютно стандартный. </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23789.png" /><a name="comment_6986012"></a><a href="https://habrahabr.ru/users/VBart/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/VBart/"><span style=" text-decoration: underline; color:#0000ff;">VBart </span></a>15.11.13 в 22:46 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+1 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6986012"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Я</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> стесняюсь спросить, но что побудило вас написать это правило внутри блока server c </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">listen 127.0.0.1:80;</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">? =) </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image18523.png" /><a name="comment_6986950"></a><a href="https://habrahabr.ru/users/Aecktann/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/Aecktann/"><span style=" text-decoration: underline; color:#0000ff;">Aecktann </span></a>16.11.13 в 08:35 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+4 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6986950"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Б</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">ыл напуган :) </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23789.png" /><a name="comment_6987938"></a><a href="https://habrahabr.ru/users/VBart/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/VBart/"><span style=" text-decoration: underline; color:#0000ff;">VBart </span></a>16.11.13 в 17:09 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+3 </span></p>
<ul type="circle" style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 5;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6987938"></a>Nginx может слушать и проксировать на unix-сокете.<br /><br /></li></ul>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:5; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">listen unix:/var/run/nginx.sock;</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:5; text-indent:0px; font-family:'Courier New,courier'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:5; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:5; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">proxy_pass http://unix:/var/run/nginx.sock;</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:5; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23789.png" /><a name="comment_6985018"></a><a href="https://habrahabr.ru/users/VBart/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/VBart/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">VBart </span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">15.11.13 в 17:56 </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+2 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985018"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">У</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">жасная же регулярка: </span><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">^.+\.(jpg|jpeg|gif|png|ico|css|js|swf|txt|ico)$</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">, почему бы хотя бы для статьи не поправить очевидные косяки? И так много у вас ico на сервере (аж дважды в регулярке встречается)?<br /><br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">location ~* \.(?:jpe?g|gif|png|ico|css|js|swf|txt)$ { .. }</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Но адекватные люди хранят статику отдельно. </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image24780.png" /><a name="comment_6985150"></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;">kashey </span></a>15.11.13 в 18:24 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">0 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985150"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Ч</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">то сказать? — Админа на мыло — в оригинале(я немного укоротил правило для статьи) еще и два png,exe и wav с bmp<br />(Как хорошо, что этот админ не я) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6995884"></a><a href="https://habrahabr.ru/users/IRainman/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">I</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">Rainman</span><a href="https://habrahabr.ru/users/IRainman/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;"> </span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">18.11.13 в 21:43 </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">0 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6995884"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">В</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">от кстати о ужасах данной регулярки, а почему, к примеру просто не добавить в исключения нужное, к примеру так:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">location ~* \.(?!php)</span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'Courier New,courier'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br />Или даже листом из необходимого: php, html, shtml (для SSI в апаче), и что там ещё м.б. </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23789.png" /><a name="comment_6996036"></a><a href="https://habrahabr.ru/users/VBart/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/VBart/"><span style=" text-decoration: underline; color:#0000ff;">VBart </span></a>18.11.13 в 22:14 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+1 </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6996036"></a>Наверное потому, что negative look-ahead не самая тривиальная конструкция в PCRE. Вот, в частности, и вы ошиблись, так работать не будет. =)<br /><br />Правильно:<br /><br /></li></ul>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">location ~* ^(?!.*\.php)</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6995998"></a><a href="https://habrahabr.ru/users/IRainman/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">I</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">Rainman</span><a href="https://habrahabr.ru/users/IRainman/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;"> </span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">18.11.13 в 22:07 </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">0 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6995998"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Н</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">у т.е. как то совсем сурово — это вот так:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> location ~* \.(?!php|html|shtml) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">       root xxx;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> }</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image23789.png" /><a name="comment_6996056"></a><a href="https://habrahabr.ru/users/VBart/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/VBart/"><span style=" text-decoration: underline; color:#0000ff;">VBart </span></a>18.11.13 в 22:17 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+1 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6996056"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">О</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">пять же, правильный вариант:<br /></span></p>
<p style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">location ~* ^(?!.*\.(?:php|s?html)) {</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">    root xxx;</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;">}</span></p>
<p style=" margin-top:0px; margin-bottom:12px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Courier New,courier'; font-size:8.25pt;"> </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6996144"></a><a href="https://habrahabr.ru/users/IRainman/"><span style=" text-decoration: underline; color:#0000ff;">I</span></a><span style=" text-decoration: underline; color:#0000ff;">Rainman</span><a href="https://habrahabr.ru/users/IRainman/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a>18.11.13 в 22:39 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">0 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6996144"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">У</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">пс, благодарю, агу, косячу. </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_7020718"></a><a href="https://habrahabr.ru/users/IRainman/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">I</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">Rainman</span><a href="https://habrahabr.ru/users/IRainman/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;"> </span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">24.11.13 в 08:23 </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">0 </span></p>
<ul type="circle" style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 3;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_7020718"></a>Забавно, попробовал сейчас у себя на сервере так, вроде всё хорошо, но перестали работать индексы (index.php и index.shtml), ну точнее именно если так написать, то всё хорошо, а вот если просто косая черта в конце, то не работает, а nginx выдаёт 403 ошибку :) Вот уж точно не тривиальные исключения, и дело наверное даже не в регулярках.<br /><br /></li></ul>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:3; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; font-weight:600;">конфиг nginx</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:3; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /><br />До этого просто из головы написал… то ли лыжи не едут, то ли у меня мозгов не хватает, хотя какие то ли, конечно же второе ))) <br /><br />Точно, руки у меня точно по этому вопросу растут не оттуда откуда следует, ибо я так ни разу и не настроил nginx как кеширующий прокси у себя ^_^' </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985310"></a><a href="https://habrahabr.ru/users/zuborg/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">z</span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">uborg</span><a href="https://habrahabr.ru/users/zuborg/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;"> </span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">15.11.13 в 18:53 </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">0 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6985310"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">Э</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">та экономия на редизайне архитектуры может Вам потом вылезти боком. Это уже проявляется, на самом деле, например, в необходимости такого рода хитрозакрученных костылей, что описаны в статье. Дальше поддерживать приемлемый уровень производительности будет ещё сложнее, увы. Вместо «хочется спать» будет противоположное.<br /><br />Все ИМХО, разумеется ;) </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image5486.png" /><a name="comment_6986498"></a><a href="https://habrahabr.ru/users/Borro/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/Borro/"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt; text-decoration: underline; color:#0000ff;">Borro </span></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">16.11.13 в 01:13 </span></p>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+1 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6986498"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">А</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;"> почему нельзя поставить на сервера, с которых вы монтируете файловые системы, nginx и уже их nginx'ы проксировать? </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image24780.png" /><a name="comment_6986984"></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;">kashey </span></a>16.11.13 в 09:12 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">+1 </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><a name="comment_6986984"></a><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">И</span><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">менно так и стоит.<br />На каждом сервере стоит и гластер-мастер и гластер-клиент. Один большой сетевой raid-1.<br />Но читать из «реальной» папки размещения файлов гластера нельзя — он разваливается. Читать можно только из папки клиента, а это уже FUSE раздел. </span></p>
<ul style="margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; -qt-list-indent: 1;"><li style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;" style=" margin-top:12px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><img src="image24780.png" /><a name="comment_6986992"></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;"> </span></a><a href="https://habrahabr.ru/users/kashey/"><span style=" text-decoration: underline; color:#0000ff;">kashey </span></a>16.11.13 в 09:19 </li></ul>
<p style="-qt-paragraph-type:empty; margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:1; text-indent:0px; font-family:'MS Shell Dlg 2'; font-size:8.25pt;"><br /></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'MS Shell Dlg 2'; font-size:8.25pt;">0 И у меня не так много серверов чтобы выстраивать два эшелона фронтов. Сейчас все нгинксы читают данные с себя.<br />А до конфига с locations я, в свое время, не додумался.</span></p></body></html>