<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Файрвол в системе linux контролируется программой iptables (для ipv4) и ip6tables (для ipv6). В данной шпаргалке рассмотрены самые распространённые способы использования iptables для тех, кто хочет защитить свою систему от взломщиков или просто разобраться в настройке.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Знак # означает, что команда выполняется от root. Откройте заранее консоль с рутовыми правами - </span><span style=" font-family:'Liberation Mono'; color:#008000;">sudo -i</span><span style=" font-family:'Liberation Mono'; color:#000000;"> в Debian-based системах или </span><span style=" font-family:'Liberation Mono'; color:#008000;">su</span><span style=" font-family:'Liberation Mono'; color:#000000;"> в остальных.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">1. Показать статус.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -L -n -v</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Примерный вывод команды для неактивного файрвола:</span></p>
<p style=" margin-top:9px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;"> pkts bytes target     prot opt in     out     source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;"> pkts bytes target     prot opt in     out     source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span></p>
<p style=" margin-top:0px; margin-bottom:9px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;"> pkts bytes target     prot opt in     out     source               destination</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Для активного файрвола:</span></p>
<p style=" margin-top:9px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain INPUT (policy DROP 0 packets, 0 bytes)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;"> pkts bytes target     prot opt in     out     source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">  394 43586 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">   93 17292 ACCEPT     all  --  br0    *       0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">    1   142 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain FORWARD (policy DROP 0 packets, 0 bytes)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;"> pkts bytes target     prot opt in     out     source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">    0     0 ACCEPT     all  --  br0    br0     0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0           state INVALID</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">    0     0 TCPMSS     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp flags:0x06/0x02 TCPMSS clamp to PMTU</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">    0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">    0     0 wanin      all  --  vlan2  *       0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">    0     0 wanout     all  --  *      vlan2   0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">    0     0 ACCEPT     all  --  br0    *       0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain OUTPUT (policy ACCEPT 425 packets, 113K bytes)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;"> pkts bytes target     prot opt in     out     source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain wanin (1 references)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;"> pkts bytes target     prot opt in     out     source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain wanout (1 references)</span></p>
<p style=" margin-top:0px; margin-bottom:9px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;"> pkts bytes target     prot opt in     out     source               destination</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Где:<br />-L : Показать список правил.<br />-v : Отображать дополнительную информацию. Эта опция показывает имя интерфейса, опции, TOS маски. Также отображает суффиксы 'K', 'M' or 'G'.<br />-n : Отображать IP адрес и порт числами (не используя DNS сервера для определения имен. Это ускорит отображение).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">2. Отобразить список правил с номерами строк.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -n -L -v --line-numbers</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Примерный вывод:</span></p>
<p style=" margin-top:9px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain INPUT (policy DROP)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">num  target     prot opt source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">1    DROP       all  --  0.0.0.0/0            0.0.0.0/0           state INVALID</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">2    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">3    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">4    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain FORWARD (policy DROP)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">num  target     prot opt source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">1    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">2    DROP       all  --  0.0.0.0/0            0.0.0.0/0           state INVALID</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">3    TCPMSS     tcp  --  0.0.0.0/0            0.0.0.0/0           tcp flags:0x06/0x02 TCPMSS clamp to PMTU</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">4    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">5    wanin      all  --  0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">6    wanout     all  --  0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">7    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain OUTPUT (policy ACCEPT)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">num  target     prot opt source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain wanin (1 references)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">num  target     prot opt source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain wanout (1 references)</span></p>
<p style=" margin-top:0px; margin-bottom:9px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">num  target     prot opt source               destination</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Вы можете использовать номера строк для того, чтобы добавлять новые правила.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">3. Отобразить INPUT или OUTPUT цепочки правил.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -L INPUT -n -v<br /># iptables -L OUTPUT -n -v --line-numbers<br /></span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">4. Остановить, запустить, перезапустить файрвол.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Силами самой системы:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># service ufw stop<br /># service ufw start</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Можно также использовать команды iptables для того, чтобы остановить файрвол и удалить все правила:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -F<br /># iptables -X<br /># iptables -t nat -F<br /># iptables -t nat -X<br /># iptables -t mangle -F<br /># iptables -t mangle -X<br /># iptables -P INPUT ACCEPT<br /># iptables -P OUTPUT ACCEPT<br /># iptables -P FORWARD ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Где:<br />-F : Удалить (flush) все правила.<br />-X : Удалить цепочку.<br />-t table_name : Выбрать таблицу (nat или mangle) и удалить все правила.<br />-P : Выбрать действия по умолчанию (такие, как DROP, REJECT, или ACCEPT).</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">5. Удалить правила файрвола.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы отобразить номер строки с существующими правилами:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -L INPUT -n --line-numbers<br /># iptables -L OUTPUT -n --line-numbers<br /># iptables -L OUTPUT -n --line-numbers | less<br /># iptables -L OUTPUT -n --line-numbers | grep 202.54.1.1</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Получим список IP адресов. Просто посмотрим на номер слева и удалим соответствующую строку. К примеру для номера 3:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -D INPUT 3</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Или найдем IP адрес источника (202.54.1.1) и удалим из правила:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -D INPUT -s 202.54.1.1 -j DROP</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Где:<br />-D : Удалить одно или несколько правил из цепочки.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">6. Добавить правило в файрвол.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы добавить одно или несколько правил в цепочку, для начала отобразим список с использованием номеров строк:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -L INPUT -n --line-numbers</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Примерный вывод:</span></p>
<p style=" margin-top:9px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain INPUT (policy DROP)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">num  target     prot opt source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">1    DROP       all  --  202.54.1.1           0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:9px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">2    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state NEW,ESTABLISHED </span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы вставить правило между 1 и 2 строкой:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -I INPUT 2 -s 202.54.1.2 -j DROP</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Проверим, обновилось ли правило:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -L INPUT -n --line-numbers</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Вывод станет таким:</span></p>
<p style=" margin-top:9px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Chain INPUT (policy DROP)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">num  target     prot opt source               destination</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">1    DROP       all  --  202.54.1.1           0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">2    DROP       all  --  202.54.1.2           0.0.0.0/0</span></p>
<p style=" margin-top:0px; margin-bottom:9px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:14.625px;"><span style=" font-family:'Liberation Mono'; color:#000000;">3    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state NEW,ESTABLISHED</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">7. Сохраняем правила файрвола.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Через iptables-save:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables-save &gt; /etc/iptables.rules</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">8. Восстанавливаем правила.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Через iptables-restore<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables-restore &lt; /etc/iptables.rules</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">9. Устанавливаем политики по умолчанию.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы сбрасывать весь трафик:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -P INPUT DROP<br /># iptables -P OUTPUT DROP<br /># iptables -P FORWARD DROP<br /># iptables -L -v -n</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">После вышеперечисленных команд ни один пакет не покинет данный хост.<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># ping google.com</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">10. Блокировать только входящие соединения.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы сбрасывать все не инициированные вами входящие пакеты, но разрешить исходящий трафик:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -P INPUT DROP<br /># iptables -P FORWARD DROP<br /># iptables -P OUTPUT ACCEPT<br /># iptables -A INPUT -m state --state NEW,ESTABLISHED -j ACCEPT<br /># iptables -L -v -n</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Пакеты исходящие и те, которые были запомнены в рамках установленных сессий - разрешены.<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># ping google.com</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">11. Сбрасывать адреса изолированных сетей в публичной сети.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -i eth1 -s 192.168.0.0/24 -j DROP<br /># iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j DROP</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Список IP адресов для изолированных сетей:<br />10.0.0.0/8 -j (A)<br />172.16.0.0/12 (B)<br />192.168.0.0/16 (C)<br />224.0.0.0/4 (MULTICAST D)<br />240.0.0.0/5 (E)<br />127.0.0.0/8 (LOOPBACK)</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">12. Блокировка определенного IP адреса.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы заблокировать адрес взломщика 1.2.3.4:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -s 1.2.3.4 -j DROP<br /># iptables -A INPUT -s 192.168.0.0/24 -j DROP</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">13. Заблокировать входящие запросы порта.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы заблокировать все входящие запросы порта 80:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -p tcp --dport 80 -j DROP<br /># iptables -A INPUT -i eth1 -p tcp --dport 80 -j DROP</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы заблокировать запрос порта 80 с адреса 1.2.3.4:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -p tcp -s 1.2.3.4 --dport 80 -j DROP<br /># iptables -A INPUT -i eth1 -p tcp -s 192.168.1.0/24 --dport 80 -j DROP</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">14. Заблокировать запросы на исходящий IP адрес.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы заблокировать определенный домен, узнаем его адрес:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># host -t a facebook.com</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Вывод: facebook.com has address 69.171.228.40</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Найдем CIDR для 69.171.228.40:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># whois 69.171.228.40 | grep CIDR</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Вывод:<br />CIDR: 69.171.224.0/19</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Заблокируем доступ на 69.171.224.0/19:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A OUTPUT -p tcp -d 69.171.224.0/19 -j DROP</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Также можно использовать домен для блокировки:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A OUTPUT -p tcp -d www.fаcebook.com -j DROP<br /># iptables -A OUTPUT -p tcp -d fаcebook.com -j DROP</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">15. Записать событие и сбросить.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы записать в журнал движение пакетов перед сбросом, добавим правило:</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j LOG --log-prefix &quot;IP_SPOOF A: &quot;<br /># iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j DROP</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Проверим журнал (по умолчанию /var/log/messages):<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># tail -f /var/log/messages<br /># grep -i --color 'IP SPOOF' /var/log/messages</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">16. Записать событие и сбросить (с ограничением на количество записей).</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы не переполнить раздел раздутым журналом, ограничим количество записей с помощью -m. К примеру, чтобы записывать каждые 5 минут максимум 7 строк:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -i eth1 -s 10.0.0.0/8 -m limit --limit 5/m --limit-burst 7 -j LOG --log-prefix &quot;IP_SPOOF A: &quot;<br /># iptables -A INPUT -i eth1 -s 10.0.0.0/8 -j DROP</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">16. Сбрасывать или разрешить трафик с определенных MAC адресов.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -m mac --mac-source 00:0F:EA:91:04:08 -j DROP<br />## *разрешить только для TCP port # 8080 с mac адреса 00:0F:EA:91:04:07 * ##<br /># iptables -A INPUT -p tcp --destination-port 22 -m mac --mac-source 00:0F:EA:91:04:07 -j ACCEPT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">17. Разрешить или запретить ICMP Ping запросы.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы запретить ping:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -p icmp --icmp-type echo-request -j DROP<br /># iptables -A INPUT -i eth1 -p icmp --icmp-type echo-request -j DROP</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Разрешить для определенных сетей / хостов:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -s 192.168.1.0/24 -p icmp --icmp-type echo-request -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Разрешить только часть ICMP запросов:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;">### ** предполагается, что политики по умолчанию для входящих установлены в DROP ** ###<br /># iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT<br /># iptables -A INPUT -p icmp --icmp-type destination-unreachable -j ACCEPT<br /># iptables -A INPUT -p icmp --icmp-type time-exceeded -j ACCEPT<br />## ** разрешим отвечать на запрос ** ##<br /># iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">18. Открыть диапазон портов.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 7000:7010 -j ACCEPT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">19. Открыть диапазон адресов.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## разрешить подключение к порту 80 (Apache) если адрес в диапазоне от 192.168.1.100 до 192.168.1.200 ##<br /># iptables -A INPUT -p tcp --destination-port 80 -m iprange --src-range 192.168.1.100-192.168.1.200 -j ACCEPT<br /></span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## пример для nat ##<br /># iptables -t nat -A POSTROUTING -j SNAT --to-source 192.168.1.20-192.168.1.25</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">20. Закрыть или открыть стандартные порты.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Заменить ACCEPT на DROP, чтобы заблокировать порт.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## ssh tcp port 22 ##<br />iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT<br />iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 22 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## cups (printing service) udp/tcp port 631 для локальной сети ##<br />iptables -A INPUT -s 192.168.1.0/24 -p udp -m udp --dport 631 -j ACCEPT<br />iptables -A INPUT -s 192.168.1.0/24 -p tcp -m tcp --dport 631 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## time sync via NTP для локальной сети (udp port 123) ##<br />iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p udp --dport 123 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## tcp port 25 (smtp) ##<br />iptables -A INPUT -m state --state NEW -p tcp --dport 25 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;"># dns server ports ##<br />iptables -A INPUT -m state --state NEW -p udp --dport 53 -j ACCEPT<br />iptables -A INPUT -m state --state NEW -p tcp --dport 53 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## http/https www server port ##<br />iptables -A INPUT -m state --state NEW -p tcp --dport 80 -j ACCEPT<br />iptables -A INPUT -m state --state NEW -p tcp --dport 443 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## tcp port 110 (pop3) ##<br />iptables -A INPUT -m state --state NEW -p tcp --dport 110 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## tcp port 143 (imap) ##<br />iptables -A INPUT -m state --state NEW -p tcp --dport 143 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## Samba file server для локальной сети ##<br />iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 137 -j ACCEPT<br />iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 138 -j ACCEPT<br />iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 139 -j ACCEPT<br />iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 445 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## proxy server для локальной сети ##<br />iptables -A INPUT -s 192.168.1.0/24 -m state --state NEW -p tcp --dport 3128 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#008000;">## mysql server для локальной сети ##<br />iptables -I INPUT -p tcp --dport 3306 -j ACCEPT</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">21. Ограничить количество параллельных соединений к серверу для одного адреса.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Для ограничений используется connlimit модуль. Чтобы разрешить только 3 ssh соединения на одного клиента:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -p tcp --syn --dport 22 -m connlimit --connlimit-above 3 -j REJECT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Установить количество запросов HTTP до 20:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -p tcp --syn --dport 80 -m connlimit --connlimit-above 20 --connlimit-mask 24 -j DROP</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Где:<br />--connlimit-above 3 : Указывает, что правило действует только если количество соединений превышает 3.<br />--connlimit-mask 24 : Указывает маску сети.</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">Помощь по iptables.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Для поиска помощи по iptables, воспользуемся man:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;">$ man iptables</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Чтобы посмотреть помощь по определенным командам и целям:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -j DROP -h</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:29.952px;"><span style=" font-family:'Liberation Mono'; font-size:x-large; color:#000000;">Проверка правила iptables.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Проверяем открытость / закрытость портов:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># netstat -tulpn</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Проверяем открытость / закрытость определенного порта:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># netstat -tulpn | grep :80</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Проверим, что iptables разрешает соединение с 80 портом:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -L INPUT -v -n | grep 80</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">В противном случае откроем его для всех:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;"># iptables -A INPUT -m state --state NEW -p tcp --dport 80 -j ACCEPT</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Проверяем с помощью telnet<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;">$ telnet ya.ru 80</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Можно использовать nmap для проверки:<br /></span><span style=" font-family:'Liberation Mono'; color:#008000;">$ nmap -sS -p 80 ya.ru</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; font-style:italic; color:#000000;">Автор статьи Platon Puhlechev aka iFalkorr разрешает печатать данный текст.</span></p>
<p style=" margin-top:13px; margin-bottom:13px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; line-height:21.6px;"><span style=" font-family:'Liberation Mono'; color:#000000;">Iptables отличный инструмент в руках администратора. Если нужно легко и просто защититься в десктопной Ubuntu, то стоит знать, что есть удобная консольная надстройка над iptables под названием UFW, а к ней есть графическая программа GUFW.</span></p></body></html>